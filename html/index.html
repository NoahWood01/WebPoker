<!doctype html>
<html>
<meta charset="utf-8">

<head>
  <title>WebPoker Group 5</title>
  <link rel="stylesheet" href="page_style.css">
</head>

<body>
  <p>
    Welcome to WebPoker with Group 5 of CSE3310.
  </p>
  <p>

    <!input id="send_text" type="text">
    <!input type="button" name="send_button" value="send" onclick="send()">
  </p>
  <div id="nameInput">
    <p>
      name:
      <input id="sendName" type="text">
      <input type="button" name="sendName" value="Name" onclick="sendName()">
    </p>
  </div>
  <div id="info_display" style="width: auto;">
      <p id="phaseNumber"       style="width: auto;"></p>
      <p id="readyDisplay"      style="width: auto;"></p>
      <p id="turnNumber"        style="width: auto;"></p>
      <p id="timeRemaining"     style="width: auto;"></p>
      <p id ="timeWarning"      style="width: auto;"></p>
      <p id="info"              style="width: auto; white-space: pre-line;"></p>
      <p id="playersTotalBets"  style="width: auto; white-space: pre-line;"></p>
      <p id="pot"               style="width: auto;"></p>
  </div>
  <p>
    Your Cards:
  </p>
  <img id="card1" src="" style="width: auto;" width="100px">
  <img id="card2" src="" style="width: auto;">
  <img id="card3" src="" style="width: auto;">
  <img id="card4" src="" style="width: auto;">
  <img id="card5" src="" style="width: auto;">
  <div id="stand_fold_display">
    <input type="button" name="sendReady" value="Ready"   onclick="sendEvent(0)">
    <input type="button" name="sendStand" value="Stand"   onclick="sendEvent(1)">
    <input type="button" name="sendFold"  value="Fold"    onclick="sendEvent(2)">
    <input type="button" name="sendBet"   value="Bet 05"  onclick="sendEvent(3)">
    <input type="button" name="sendBet"   value="Bet 10"  onclick="sendEvent(4)">
    <input type="button" name="sendBet"   value="Bet 20"  onclick="sendEvent(5)">
    <input type="button" name="sendBet"   value="Sort"  onclick="sendEvent(6)">
    <p>
      Draw cards (give the card index no spaces) (ex: 123):
      <input id="send_index" type="text">
      <input type="button" name="sendDraw" value="Draw" onclick="sendEvent(7)">
    </p>
  </div>

</body>

</html>
<script>
  var playerID;
  var name;
  var playerObj;
  var cardIdx = 0;

  var serverUrl ="ws://" + window.location.hostname + ":8880";
  var connection = new WebSocket(serverUrl);

  connection.onopen = function (evt){
    console.log("open");
  }

  connection.onmessage = function(evt) {
    console.log("message: " + evt.data);
    var msg;
    msg = evt.data;

    // This is a hack for this example.
    // The only time the WebPoker server sends data just
    // to this client is at the beginging, when the connection
    // is first made.  The first communication tells us which
    // connection number we are, which is very import.
    // So, we detect this situation where it is not game state

    // Take the msg and turn it into a javascript object
    const obj = JSON.parse(msg);

    // This is specifically for functionality sent from onOpen in WebSocket.java

    if(obj.name == "not set"){
        playerID = obj.id;
        console.log("Player id: " + playerID);
    }
    else {
      // process the game state
      // this will just have one card change every time a new game state comes in.
      // the term LUT means "look up table".  you will see it sometimes in code written last
      // century.

      for(var i = 0; i < obj.players.length; i++)
      {
          if(obj.players[i].name == document.getElementById("sendName").value)
          {
              playerObj = obj.players[i];
              //console.log(playerObj);
          }
      }



      // display whose turn it is
      if(obj.phase == 0)
      {
          document.getElementById("phaseNumber").innerHTML = "Phase: PreGame";
          document.getElementById("readyDisplay").innerHTML = "Waiting for players to ready up...";
      }
      else if(obj.phase == 1)
      {
          document.getElementById("readyDisplay").innerHTML = "";
          document.getElementById("phaseNumber").innerHTML = "Phase: First Bet Phase";
      }
      else if(obj.phase == 2)
      {
          document.getElementById("phaseNumber").innerHTML = "Phase: Draw Phase";
      }
      else if(obj.phase == 3)
      {
          document.getElementById("phaseNumber").innerHTML = "Phase: Second Bet Phase";
      }
      else if(obj.phase == 4)
      {
          document.getElementById("phaseNumber").innerHTML = "Phase: Showdown";
      }
      else if(obj.phase == 5)
      {
          if(obj.winner != -1)
          {
              document.getElementById("phaseNumber").innerHTML = "Winner: Player "
              + obj.winner + "(" + obj.players[obj.winner].name + ")"
              + " won " + obj.winnings + " chips";
          }
          else
          {
              // tie situation
              document.getElementById("phaseNumber").innerHTML = "Tie! Both Players"
              + " won " + obj.pot.pot/2 + " chips";
          }
          document.getElementById("readyDisplay").innerHTML = "Ready Up to play again!";

          document.getElementById("turnNumber").innerHTML = "";

          /*
          var x = document.getElementById("stand_fold_display");

          if(x.style.display === "none")
          {
              x.style.display = "block";
          }
          else
          {
              x.style.display = "none";
          }
          */

          document.getElementById("info").innerHTML
            = "Player Wallet: " + obj.players[playerID].wallet
            + "\n"
            + "Player Name: "   + obj.players[playerID].name
            + "\n"
            + "Player Id: "     + obj.players[playerID].id;

          // display the amount in the pot
          document.getElementById("pot").innerHTML = "Total Pot: " + obj.pot.pot;
      }

      if(obj.timeRemaining > -1)
      {
          document.getElementById("timeRemaining").innerHTML = " Time Left: " + obj.timeRemaining;
      }
      else
      {
          document.getElementById("timeRemaining").innerHTML = "";
      }


      if(obj.timeRemaining <= 10 && obj.timeRemaining > -1)
      {
          document.getElementById("timeWarning").innerHTML = "Please make a choice or you will be folded!";
      }
      else
      {
          document.getElementById("timeWarning").innerHTML = "";
      }

      if(obj.turn != -1)
      {
          document.getElementById("turnNumber").innerHTML = "Turn: Player " + obj.turn
            + "\n | " + "Turn player based: Player " + obj.currentplayer.id + "("+
            obj.currentplayer.name + ")";
      }

      document.getElementById("info").innerHTML
        = "Player Wallet: " + obj.players[playerID].wallet
        + "\n"
        + "Player Name: "   + obj.players[playerID].name
        + "\n"
        + "Player Id: "     + obj.players[playerID].id;

      // display the amount in the pot
      document.getElementById("pot").innerHTML = "Total Pot: " + obj.pot.pot;

      // display the total bets of all players
      var playerTotalBetString = "";
      for(var i = 0; i < obj.players.length; i++)
      {
        playerTotalBetString += "Player " + i + " (" + obj.players[i].name
                             + ") Current Bet: " + obj.players[i].currentBet
                             + " ready: " + obj.players[i].ready
                             + "\n";
      }
      document.getElementById("playersTotalBets").innerHTML = playerTotalBetString;

      // display the player's cards
      var player = obj.players[playerID];
      for(var i = 0; i < 5; i++){
        // if cards are null str becomes empty so nothing is displayed
        var str = "";
        if(player.Cards[i] == null) str = "";
        else{
            var card = player.Cards[i];
            if(card.value == "ACE")             str += "A";
            else if(card.value == "TWO")        str += "2";
            else if(card.value == "THREE")      str += "3";
            else if(card.value == "FOUR")       str += "4";
            else if(card.value == "FIVE")       str += "5";
            else if(card.value == "SIX")        str += "6";
            else if(card.value == "SEVEN")      str += "7";
            else if(card.value == "EIGHT")      str += "8";
            else if(card.value == "NINE")       str += "9";
            else if(card.value == "TEN")        str += "T";
            else if(card.value == "JACK")       str += "J";
            else if(card.value == "QUEEN")      str += "Q";
            else if(card.value == "KING")       str += "K";

            if(card.suite == "SPADES")         str += "S";
            else if(card.suite == "HEARTS")    str += "H";
            else if(card.suite == "CLUBS")     str += "C";
            else if(card.suite == "DIAMONDS")  str += "D";

            str += ".svg";
        }

        var cardnumber = "card" + (i+1);
        document.getElementById(cardnumber).src = str;
      }
    }
    console.log("the cardIdx is " + cardIdx);
  }

  // send info from the buttons where
  // 1 is STAND
  // 2 is Draw
  // 3 is Bet
  // 4 is fold
  // passed as an argument from button
  function sendEvent(option){
    // send a UserEvent in JSON
    var eventType;
    var amount = 0;
    var amountDraw = 0;
    var indexes = [0, 0, 0];
    if(option == 0)
    {
        eventType = "READY";
    }
    else if(option == 1){
      eventType = "STAND";

      var x = document.getElementById("stand_fold_display");

      //if(x.style.display === "none"){ x.style.display = "block"; }
      //else{ x.style.display = "none"; }
    }         // event type is STAND
    else if(option == 2){                           // event type is  FOLD
      eventType = "FOLD";

      /*
      var x = document.getElementById("stand_fold_display");

      if(x.style.display === "none"){ x.style.display = "block"; }
      else{ x.style.display = "none"; }
      */
    }
    else if(option == 3){                           // event type is BET
      eventType = "BET";
      amount = 5;
    }
    else if(option == 4){                           // event type is BET
      eventType = "BET";
      amount = 10;
    }
    else if(option == 5){                           // event type is BET
      eventType = "BET";
      amount = 20;
    }

    else if(option == 6){
      eventType = "SORT";
    }
    else if(option == 7){                           // event type is DRAW
      eventType = "DRAW";

      // get the indexes of the cards
      var str = document.getElementById("send_index").value;
      arr = str.split("");
      var iteration = arr.length;

      if(arr.length > 3) iteration = 3;                                             // Prevent for loop from iterating more than 3 times

      for(var i = 0; i < iteration; i++) indexes[i] = parseInt(arr[i], 10);         // parse and store the indexes as ints
    }

    // create the object to be sent to the game server
    const msg = {
        event: eventType,
        name: document.getElementById("sendName").value,
        playerID: playerID,
        player: playerObj,
        amount_to_bet: amount,
        amount_to_draw: amountDraw,
        give_card_indexes: indexes
    };
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));
  }

  function send() {
    var msg = {
      text: document.getElementById("send_text").value,
    };
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));
  }

  function sendName(){
    var msg = {
      event: "NAME",
      name: document.getElementById("sendName").value,
      playerID: playerID,
      player: null,
      amount_to_bet: 0,
      amount_to_draw: 0,
      give_card_indexes: [-1,-1,-1]
    };
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));

    // this shows how to hid html elements.
    // like when the name is entered
    // it might be better to hide after the server has accepted it
    // but this is just a demonstration

    var x = document.getElementById("nameInput");
    console.log("X: " + x);
    console.log("X display: " + x.style.display);
    if(x.style.display === "none"){ x.style.display = "block"; }
    else{ x.style.display = "none"; }
  }
</script>
