<!doctype html>
<html>
<meta charset="utf-8">

<head>
  <title>WebPoker Group 5</title>
  <link rel="stylesheet" href="page_style.css">
</head>

<body>
  <p> 
    Welcome to WebPoker with Group 5 of CSE3310.
  </p>
  <p>
    message: 
    <input id="send_text" type="text">
    <input type="button" name="send_button" value="send" onclick="send()">
  </p>
  <div id="nameInput">
    <p>
      name: 
      <input id="sendName" type="text">
      <input type="button" name="sendName" value="Name" onclick="sendName()">
    </p>
  </div>
  <div>
      <p id="turnNumber" style="width:auto;"></p>
      <p id="info" style="width:auto;"></p>
      <p id="pot" style="width:auto;"></p>
      <p id="wallet" style="width:auto;"></p>
      <p id="playersTotalBets" style="width:auto;"></p>
      
  </div>
  <p> 
    Your Cards:
  </p>
  <img id="card1" src="" style="width:auto;">
  <img id="card2" src="" style="width:auto;">
  <img id="card3" src="" style="width:auto;">
  <img id="card4" src="" style="width:auto;">
  <img id="card5" src="" style="width:auto;">
  <div>
    <input type="button" name="sendAnte" value="Ante" onclick="sendEvent(5)">
    <input type="button" name="sendStand" value="Stand" onclick="sendEvent(1)">
    <p>
      Draw cards (gives the card numbers (ex: 1 2 3): 
      <input id="send_index" type="text">
      <input type="button" name="sendDraw" value="Draw" onclick="sendEvent(2)">
    </p>
    <p>
      Bet: 
      <input id="send_bet" type="text">
      <input type="button" name="sendBet" value="Bet" onclick="sendEvent(3)">
    </p>
    <input type="button" name="sendFold" value="Fold" onclick="sendEvent(4)">
  </div>
  
</body>

</html>
<script>
  var playerID;
  var cardIdx = 0;

  var serverUrl ="ws://" + window.location.hostname + ":8880";
  var connection = new WebSocket(serverUrl);

  connection.onopen = function (evt){
    console.log("open");
  }

  connection.onmessage = function(evt) {

    console.log("message: " + evt.data);
    var msg;
    msg = evt.data;

    // This is a hack for this example.
    // The only time the WebPoker server sends data just
    // to this client is at the beginging, when the connection
    // is first made.  The first communication tells us which
    // connection number we are, which is very import.
    // So, we detect this situation where it is not game state

    // Take the msg and turn it into a javascript object
    const obj = JSON.parse(msg);

    // This is specifically for functionality sent from onOpen in WebSocket.java 

    if(obj.name == "not set"){              
        playerID = obj.id;
        console.log("Player id: " + playerID);
    }
    else {
      // process the game state
      // this will just have one card change every time a new game state comes in.
      // the term LUT means "look up table".  you will see it sometimes in code written last
      // century.

/*
      cardLUT = ["3C.svg", "2B.svg", "3S.svg", "KC.svg", "6D.svg", "2J.svg", "2S.svg"];

      document.getElementById("card4").src = cardLUT[cardIdx];
      cardIdx = cardIdx + 1;
      if (cardIdx > 6)
        cardIdx = 0;
*/

        // display whose turn it is
        document.getElementById("turnNumber").innerHTML = "Turn: Player " + obj.turn;

        // display the amount in the pot
        document.getElementById("pot").innerHTML = "Total Pot: " + obj.pot;
        document.getElementById("info").innerHTML 
          = "Player Wallet: " + obj.players[playerID].wallet  
          + "\n"
          + "Player Name: "   + obj.players[playerID].name 
          + "\n"
          + "Player Id: "     + obj.players[playerID].id;
        

        // display the total bets of all players
        var playerTotalBetString = "";
        for(var i = 0; i < obj.players.length; i++)
        {
            playerTotalBetString += "Player " + i + " (" + obj.players[i].Name;
            playerTotalBetString += ") Total Bet: " + obj.players[i].totalBet;
            playerTotalBetString += " Round Bet: " + obj.players[i].currentBet;
            playerTotalBetString += " | ";
        }
        document.getElementById("playersTotalBets").innerHTML = playerTotalBetString;

        // display the player's cards
        var player = obj.players[playerID];

        for(var i = 0; i < 5; i++){
          var str = player.Cards[i].value + player.Cards[i].suite + ".svg";

          var number = i + 1;
          var cardnumber = "card" + number;
          document.getElementById(cardnumber).src = str;
        }
    }
    console.log("the cardIdx is " + cardIdx)
  }

  // send info from the buttons where
  // 1 is STAND
  // 2 is Draw
  // 3 is Bet
  // 4 is fold
  // passed as an argument from button
  function sendEvent(option){
      // send a UserEvent in JSON
      var eventType;
      var amount = 0;
      var amountDraw = 0;
      var indexes = [0, 0, 0];

      // event type is STAND
      if(option == 1){ eventType = "STAND"; }

      // event type is DRAW
      else if(option == 2){
          eventType = "DRAW";

          // get the indexes of the cards
          var str = document.getElementById("send_index").value;
          arr = str.split("");
          var iteration = arr.length;

          if(arr.length > 3) iteration = 3;                                             // Prevent for loop from iterating more than 3 times

          for(var i = 0; i < iteration; i++) indexes[i] = parseInt(arr[i], 10);         // parse and store the indexes as ints 
      }
      // event type is BET
      else if(option == 3)
      {
          eventType = "BET";
          amount = parseInt(document.getElementById("send_bet").value,10);
      }
      // event type is BET
      else if(option == 4) { eventType = "FOLD"; }
      else if(option == 5) { eventType = "ANTE"; }

      // create the object to be sent to the game server
      const msg = {
          event: eventType,
          name: document.getElementById("sendName").value,
          playerID: playerID,
          amount_to_bet: amount,
          amount_to_draw: amountDraw,
          give_card_indexes: indexes
      };
      connection.send(JSON.stringify(msg));
      console.log(JSON.stringify(msg));
  }

  function send() {
    var msg = {
      text: document.getElementById("send_text").value,
    };
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));
  }

  function sendName(){
    var msg = {
      event: "NAME",
      name: document.getElementById("sendName").value,
      playerID: playerID,
      amount_to_bet: 0,
      amount_to_draw: 0,
      give_card_indexes: [-1,-1,-1]
    };
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));

    // this shows how to hid html elements.
    // like when the name is entered
    //  it might be better to hide after the server has accepted it
    // but this is just a demonstration

    var x = document.getElementById("nameInput");
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }

  }

</script>